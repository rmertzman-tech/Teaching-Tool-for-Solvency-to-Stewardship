<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Budget Guardrails & Trade-Off Explorer (App 2)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#f8fafc; --panel:#ffffff; --ink:#0f172a; --muted:#475569;
    --line:#e2e8f0; --accent:#2563eb; --chip:#eef2ff; --ok:#16a34a; --warn:#ca8a04; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; color:var(--ink); background:var(--bg);}
  header{background:linear-gradient(180deg,#ffffff 0%, #f3f6fb 100%); border-bottom:1px solid var(--line);}
  .wrap{max-width:1100px; margin:0 auto; padding:24px;}
  h1{margin:0 0 4px 0; font-size:24px}
  h2{margin:18px 0 8px; font-size:18px}
  p.lead{color:var(--muted); margin:0 0 10px 0}
  .bar{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .panel{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px}
  .grid{display:grid; gap:16px}
  @media(min-width:960px){ .grid.cols-2{grid-template-columns:1fr 1fr} }

  select, button, input[type="text"], textarea{
    font:inherit; padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff;
  }
  button.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
  button.ghost{background:#fff}
  .small{font-size:12px}
  .muted{color:var(--muted)}
  .hint{color:var(--muted)}
  .chip{background:var(--chip); padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e0e7ff}
  .row{display:flex; gap:10px; align-items:flex-start}
  .line{height:1px; background:var(--line); margin:10px 0}
  .info{display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; border-radius:999px; border:1px solid var(--line); color:var(--muted); font-size:12px; margin-left:6px; cursor:pointer; user-select:none}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--line); border-radius:999px; background:#fff}
  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
  .kpi{border:1px solid var(--line); border-radius:10px; padding:10px; background:#fff}
  .kpi h4{margin:0 0 6px 0; font-size:12px; color:var(--muted)}
  .meter{height:10px; background:#f1f5f9; border-radius:999px; overflow:hidden; border:1px solid var(--line)}
  .meter div{height:100%}
  .meter .s{background:var(--ok)}
  .meter .j{background:#22c55e}
  .meter .g{background:#38bdf8}
  .meter .a{background:#a78bfa}
  .bad{color:var(--bad)}
  .good{color:var(--ok)}
  .cards{display:grid; gap:12px}
  .card{border:1px solid var(--line); border-radius:12px; padding:12px; background:#fff; display:flex; gap:10px; align-items:flex-start}
  .card label{display:flex; gap:8px; align-items:flex-start; flex:1}
  .note{margin-top:4px}
  .why{font-size:12px; color:var(--muted)}
  .footer{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:6px}
  .tooltip{position:absolute; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; max-width:320px; font-size:13px; line-height:1.4; display:none; z-index:30; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .tooltip h4{margin:0 0 6px 0; font-size:13px}
  .right{text-align:right}
  .tag{font-size:10px; background:#f1f5f9; border:1px solid var(--line); padding:2px 6px; border-radius:8px}
  .glossary{max-height:0; overflow:hidden; transition:max-height .25s ease}
  .glossary.open{max-height:600px}
  .gl-list{display:grid; grid-template-columns:1fr; gap:10px}
  .gl-item{border:1px solid var(--line); border-radius:10px; padding:10px; background:#fff}
  .print-only{display:none}
  @media print{
    body{background:#fff}
    .no-print{display:none !important}
    .print-only{display:block}
    #cheatSheet{border:none}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Budget Guardrails & Trade-Off Explorer</h1>
    <p class="lead">A step-by-step trainer that links solvency with stewardship. Learn to pick “rules you can live with,” see trade-offs, and keep a short reflective memo you can justify to others.</p>
    <div class="bar">
      <div class="pill">Start here
        <span class="info" data-key="start">i</span>
      </div>
      <div class="pill">Rules of the Game
        <span class="info" data-key="rules">i</span>
      </div>
      <div class="pill">Visualize Trade-offs
        <span class="info" data-key="viz">i</span>
      </div>
      <div class="pill">Glossary
        <span class="info" data-key="glossary">i</span>
      </div>
      <div class="pill">One-page Cheat Sheet
        <span class="info" data-key="cheat">i</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap grid cols-2">

  <!-- Left: Controls and Guardrails -->
  <section class="panel">
    <h2>1) Choose your context</h2>
    <div class="row" style="align-items:center">
      <label for="context" class="muted small">Context</label>
      <select id="context" aria-label="Choose context">
        <option value="student">Student (part-time work)</option>
        <option value="youngAdult">Young Adult (early career)</option>
        <option value="parent">Parent (household)</option>
        <option value="caregiver">Caregiver (variable income)</option>
      </select>
      <span class="chip" id="ctxDesc">Balancing classes, rent, and early savings with justice-minded habits.</span>
    </div>

    <div class="line"></div>

    <div class="row" style="align-items:center; flex-wrap:wrap; gap:8px 12px">
      <strong>Preset:</strong>
      <button class="ghost small" data-preset="minimal">Minimal</button>
      <button class="ghost small" data-preset="balanced">Balanced</button>
      <button class="ghost small" data-preset="justice">Justice-forward</button>
      <span class="hint small">You can still toggle items after loading a preset.</span>
    </div>

    <div class="line"></div>

    <h2>2) Pick your guardrails
      <span class="info" data-key="guardrails">i</span>
    </h2>
    <div id="guardrails" class="cards" aria-live="polite"></div>

    <div class="footer">
      <div>
        <button class="ghost small" id="clearAll">Clear all</button>
        <button class="ghost small" id="selectAll">Select all</button>
      </div>
      <div class="small muted">Each “why?” explains the ethical rationale and the expected effect.</div>
    </div>
  </section>

  <!-- Right: KPIs, Reflection, Glossary, Export -->
  <section class="panel">
    <h2>3) Predicted impacts</h2>
    <div class="kpis" id="kpis">
      <div class="kpi"><h4>Stability</h4><div class="meter"><div class="s" style="width:0%"></div></div><div class="small muted" id="s_txt">0%</div></div>
      <div class="kpi"><h4>Justice</h4><div class="meter"><div class="j" style="width:0%"></div></div><div class="small muted" id="j_txt">0%</div></div>
      <div class="kpi"><h4>Growth</h4><div class="meter"><div class="g" style="width:0%"></div></div><div class="small muted" id="g_txt">0%</div></div>
      <div class="kpi"><h4>Autonomy</h4><div class="meter"><div class="a" style="width:0%"></div></div><div class="small muted" id="a_txt">0%</div></div>
    </div>

    <div class="line"></div>

    <h2>4) Reflect (memo)
      <span class="info" data-key="memo">i</span>
    </h2>
    <textarea id="memo" rows="6" placeholder="Why did you pick these rules? What trade-offs are you accepting? What would count as ‘working’?"></textarea>
    <div class="right small muted" id="charCount">0/600</div>

    <div class="line"></div>

    <h2>5) One-page cheat sheet
      <span class="info" data-key="cheat">i</span>
    </h2>
    <div class="row">
      <button id="printCheat" class="ghost">Print / Save PDF</button>
      <button id="toggleGlossary" class="ghost">Toggle Glossary</button>
    </div>
    <div id="cheatSheet" class="panel" style="margin-top:10px">
      <h3 style="margin-top:0">Cheat Sheet: Solvency ↔ Stewardship</h3>
      <ul class="small">
        <li><strong>Pick rules you can live with:</strong> automate where possible; keep exceptions explicit.</li>
        <li><strong>Design for trade-offs:</strong> stability, justice, growth, autonomy rarely all max at once.</li>
        <li><strong>Review monthly:</strong> What changed? What worked? What failed and why?</li>
        <li><strong>Document evidence:</strong> text/data, empirical trial, lived experience—keep all in view.</li>
        <li><strong>Pluralism by design:</strong> your path needn’t be the same as others’ to be ethically serious.</li>
      </ul>
      <div class="line"></div>
      <div class="small muted">Tip: Export your state and attach it to your reflection journal.</div>
    </div>

    <div class="line"></div>

    <div>
      <h2 style="display:inline">Glossary</h2>
      <span class="tag">PRF</span> <span class="tag">SPTS</span> <span class="tag">OS1</span> <span class="tag">OS2</span>
      <div id="glossary" class="glossary" aria-live="polite" aria-expanded="false" style="margin-top:10px">
        <div class="gl-list" id="glList"></div>
      </div>
    </div>

    <div class="line"></div>

    <h2>Save / Load</h2>
    <div class="row">
      <button id="btnExport">Export JSON</button>
      <button id="btnImport">Import JSON</button>
      <input type="file" id="file" accept="application/json" style="display:none">
    </div>
  </section>

</main>

<!-- Tooltip node -->
<div id="tooltip" class="tooltip" role="dialog" aria-hidden="true"></div>

<script>
/* -------------------------
   Data: contexts & guardrails
-------------------------- */
const CONTEXTS = {
  student: {
    desc: "Balancing classes, rent, and early savings with justice-minded habits.",
    guardrails: [
      { id:"pyf5",   label:"Pay-Yourself-First 5% buffer", note:"Stability first: a small buffer reduces downstream harm (fees, debt).", vec:{s:2,j:0,g:1,a:1}},
      { id:"rent35", label:"Rent ≤ 35% of net income",      note:"Avoids cost traps; supports future mobility.", vec:{s:2,j:0,g:1,a:0}},
      { id:"cool24", label:"24-hour cool-off for non-essentials", note:"Protects autonomy from impulse; reduces waste.", vec:{s:1,j:0,g:0,a:2}},
      { id:"lowwaste", label:"Prefer used/repair over new when function-equivalent", note:"Lower footprint while meeting needs.", vec:{s:1,j:2,g:0,a:0}},
      { id:"fairlab", label:"Screen for fair labor on big purchases", note:"Aligns purchases with dignity of workers.", vec:{s:0,j:3,g:0,a:-1}},
      { id:"give1", label:"Give 1% to a cause you can explain", note:"Practices solidarity; keeps justice visible.", vec:{s:-1,j:2,g:0,a:0}},
      { id:"translog", label:"Monthly transparency memo (30 min)", note:"Turns choices into accountable practice.", vec:{s:1,j:1,g:1,a:1}}
    ],
    presets:{
      minimal:["pyf5","rent35","cool24"],
      balanced:["pyf5","rent35","cool24","lowwaste","translog"],
      justice:["pyf5","rent35","cool24","lowwaste","fairlab","give1","translog"]
    }
  },
  youngAdult:{
    desc:"Early career: grow skills while maintaining stability and social impact.",
    guardrails:[
      { id:"pyf10", label:"Pay-Yourself-First 10% (buffer + invest)", note:"Future stability and optionality.", vec:{s:3,j:0,g:2,a:1}},
      { id:"rent30", label:"Rent ≤ 30% net", note:"Keeps pressure low; room to invest and learn.", vec:{s:2,j:0,g:1,a:0}},
      { id:"skillwk", label:"1 skill module/week + 1 portfolio artifact", note:"Compounding career growth.", vec:{s:0,j:0,g:3,a:1}},
      { id:"lowwaste", label:"Used/repair first for function-equivalent goods", note:"Lower harm without loss of function.", vec:{s:1,j:2,g:0,a:0}},
      { id:"fairlab", label:"Fair-labor screen on fashion/electronics", note:"Aligns consumption with worker dignity.", vec:{s:0,j:3,g:0,a:-1}},
      { id:"give1", label:"Give 1% to a vetted org you can defend", note:"Keeps justice salient; build habit.", vec:{s:-1,j:2,g:0,a:0}},
      { id:"translog", label:"Monthly transparency memo", note:"Accountability & learning loop.", vec:{s:1,j:1,g:1,a:1}}
    ],
    presets:{
      minimal:["pyf10","rent30","skillwk"],
      balanced:["pyf10","rent30","skillwk","lowwaste","translog"],
      justice:["pyf10","rent30","skillwk","lowwaste","fairlab","give1","translog"]
    }
  },
  parent:{
    desc:"Household obligations with fairness and sustainability in view.",
    guardrails:[
      { id:"buffer", label:"3-month expenses buffer (build over time)", note:"Resilience for dependents.", vec:{s:3,j:0,g:1,a:1}},
      { id:"insure", label:"Basic insurance (health/renters/term-life)", note:"Risk transfer protects the vulnerable.", vec:{s:3,j:0,g:0,a:0}},
      { id:"usedkids", label:"Used kids’ gear when safe & equivalent", note:"Lower waste; same function.", vec:{s:1,j:2,g:0,a:0}},
      { id:"local", label:"Local vendors when feasible", note:"Strengthens community resilience.", vec:{s:1,j:2,g:0,a:-1}},
      { id:"give1", label:"Family giving rule (1% + kids choose an org)", note:"Models solidarity & agency.", vec:{s:0,j:2,g:0,a:1}},
      { id:"translog", label:"Monthly transparency memo (family check-in)", note:"Shared learning and fairness.", vec:{s:1,j:1,g:1,a:1}}
    ],
    presets:{
      minimal:["buffer","insure"],
      balanced:["buffer","insure","usedkids","translog"],
      justice:["buffer","insure","usedkids","local","give1","translog"]
    }
  },
  caregiver:{
    desc:"Variable income; commitments to dependents; reduce harm where possible.",
    guardrails:[
      { id:"microbuf", label:"Micro-buffer: $25/week until 1 month saved", note:"Buffers shocks without big strain.", vec:{s:2,j:0,g:0,a:1}},
      { id:"cool48", label:"48-hour cool-off > $75", note:"Protects autonomy under stress.", vec:{s:1,j:0,g:0,a:2}},
      { id:"aidnet", label:"Map and use 3 mutual-aid resources", note:"Dignified support; reciprocity later.", vec:{s:2,j:1,g:0,a:0}},
      { id:"lowwaste", label:"Repair > replace when safe", note:"Lower footprint; saves money.", vec:{s:1,j:2,g:0,a:0}},
      { id:"translog", label:"Monthly memo (10-minute version)", note:"Gentle loop to keep learning.", vec:{s:1,j:1,g:1,a:1}}
    ],
    presets:{
      minimal:["microbuf","cool48"],
      balanced:["microbuf","cool48","lowwaste","translog"],
      justice:["microbuf","cool48","aidnet","lowwaste","translog"]
    }
  }
};

/* Glossary entries */
const GLOSSARY = {
  start:{title:"Start here", body:"Pick a context, then toggle guardrails. Each guardrail is a small, testable rule: easy to follow, with a clear 'why' and a predictable effect."},
  rules:{title:"Rules of the Game", body:"Favor simple rules you can keep. When a rule fails, record the exception and revise. Evidence can be text/data, trial results, or lived experience—keep all three visible."},
  viz:{title:"Visualize Trade-offs", body:"Your choices shift Stability, Justice, Growth, and Autonomy. There’s no free lunch; this panel shows the pattern you’re building."},
  guardrails:{title:"Guardrails", body:"Guardrails are capability-level rules (e.g., ‘24-hour cool-off’). They reduce bad variance and align habits with your ethics."},
  memo:{title:"Reflection Memo", body:"Briefly justify your choices. What trade-offs are you accepting, and how will you know if this is working?"},
  cheat:{title:"Cheat Sheet", body:"A printable one-pager with the core method and reminders. Use it during monthly reviews."},
  glossary:{title:"Glossary", body:"Key course terms used across the app."},
  PRF:{title:"PRF (Phenomenal Reference Frame)", body:"Your current internal model: values, filters, vocabulary, habits, and roles that shape what feels visible and valid right now."},
  SPTS:{title:"SPTS (Standpoints)", body:"Structured positions you occupy (e.g., student, parent). These set defaults for ‘whose voice counts’ and what trade-offs you face."},
  OS1:{title:"OS1 (Lived Experience)", body:"First-person, moment-to-moment experience—what shows up as salient now."},
  OS2:{title:"OS2 (Design & Review)", body:"The procedure-making plane: you design guardrails, gates, and review loops you can justify to others."}
};

/* -------------------------
   State
-------------------------- */
const state = {
  contextKey:"student",
  selected:new Set(),
  memo:"",
};

function impactChip(v){
  // simple sign preview
  const score = v.s+v.j+v.g+v.a;
  const mark = score>3 ? "▲ strong +" : score>=1 ? "▲ +" : score===0 ? "•" : "▼";
  return `<span class="chip">${mark}</span>`;
}

/* -------------------------
   Rendering
-------------------------- */
function byId(id){ return document.getElementById(id); }
function qs(s,el=document){ return el.querySelector(s); }
function qsa(s,el=document){ return [...el.querySelectorAll(s)]; }

function renderContextDesc(){
  byId("ctxDesc").textContent = CONTEXTS[state.contextKey].desc;
}

function renderGuardrails(){
  const box = byId("guardrails");
  box.innerHTML = "";
  const ctx = CONTEXTS[state.contextKey];
  ctx.guardrails.forEach(g=>{
    const wrap = document.createElement("div");
    wrap.className = "card";
    // safe attribute for quotes in data-tip:
    const tipAttr = g.note.replace(/"/g,'&quot;');
    wrap.innerHTML = `
      <input type="checkbox" id="gr_${g.id}" ${state.selected.has(g.id)?"checked":""} aria-label="${g.label}">
      <label for="gr_${g.id}">
        <div>
          <div><strong>${g.label}</strong>
            <span class="info" data-tip="${tipAttr}" aria-label="Why this matters" tabindex="0">i</span>
          </div>
          <div class="note why small">${g.note}</div>
        </div>
      </label>
      <span class="chip">${impactChip(g.vec)}</span>
    `;
    box.appendChild(wrap);
    wrap.querySelector("input").addEventListener("change", e=>{
      if(e.target.checked) state.selected.add(g.id); else state.selected.delete(g.id);
      computeImpacts(); renderImpacts(); syncCheat(); syncExport();
    });
  });
  // re-bind tooltips for new .info icons
  wireTooltips();
}

function computeImpacts(){
  const ctx = CONTEXTS[state.contextKey];
  let s=0,j=0,g=0,a=0, n=0;
  ctx.guardrails.forEach(gr=>{
    if(state.selected.has(gr.id)){ s+=gr.vec.s; j+=gr.vec.j; g+=gr.vec.g; a+=gr.vec.a; n++; }
  });
  // Normalize to a rough 0–100 visual scale: assume max 3 per dim * N
  const mx = Math.max(1, n*3);
  state.impacts = {
    s: Math.max(0, Math.min(100, Math.round((s/mx)*100))),
    j: Math.max(0, Math.min(100, Math.round((j/mx)*100))),
    g: Math.max(0, Math.min(100, Math.round((g/mx)*100))),
    a: Math.max(0, Math.min(100, Math.round((a/mx)*100))),
  };
}

function renderImpacts(){
  const {s,j,g,a} = state.impacts || {s:0,j:0,g:0,a:0};
  qs(".meter .s").style.width = s+"%";
  qs(".meter .j").style.width = j+"%";
  qs(".meter .g").style.width = g+"%";
  qs(".meter .a").style.width = a+"%";
  byId("s_txt").textContent = s+"%";
  byId("j_txt").textContent = j+"%";
  byId("g_txt").textContent = g+"%";
  byId("a_txt").textContent = a+"%";
}

/* -------------------------
   Presets
-------------------------- */
function applyPreset(name){
  const ctx = CONTEXTS[state.contextKey];
  const ids = ctx.presets?.[name] || [];
  state.selected = new Set(ids);
  renderGuardrails();
  computeImpacts(); renderImpacts(); syncCheat(); syncExport();
}

/* -------------------------
   Memo / Character counter
-------------------------- */
function wireMemo(){
  const ta = byId("memo");
  const cc = byId("charCount");
  ta.addEventListener("input", ()=>{
    state.memo = ta.value;
    cc.textContent = `${ta.value.length}/600`;
    if(ta.value.length>600) ta.value = ta.value.slice(0,600);
    syncCheat(); syncExport();
  });
}

/* -------------------------
   Cheat Sheet print (print only that panel)
-------------------------- */
function printCheat(){
  // Use print CSS to only print the cheat panel
  window.print();
}
function syncCheat(){
  // could inject a short summary if desired; for now the sheet is static tips
}

/* -------------------------
   Glossary (expandable)
-------------------------- */
function renderGlossary(){
  const gl = byId("glList");
  gl.innerHTML = "";
  const keys = ["PRF","SPTS","OS1","OS2"];
  keys.forEach(k=>{
    const it = document.createElement("div");
    it.className = "gl-item";
    it.innerHTML = `<strong>${GLOSSARY[k].title}</strong><div class="small muted" style="margin-top:4px">${GLOSSARY[k].body}</div>`;
    gl.appendChild(it);
  });
}

/* -------------------------
   Export / Import
-------------------------- */
function syncExport(){
  // store a lightweight snapshot
  stateSnapshot = {
    contextKey: state.contextKey,
    selected: [...state.selected],
    memo: state.memo || ""
  };
}
function doExport(){
  const blob = new Blob([JSON.stringify(stateSnapshot,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="guardrails-state.json"; a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 2000);
}
function doImport(file){
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const obj = JSON.parse(e.target.result);
      if(obj.contextKey && CONTEXTS[obj.contextKey]) state.contextKey = obj.contextKey;
      state.selected = new Set(Array.isArray(obj.selected)? obj.selected : []);
      state.memo = obj.memo || "";
      // reflect UI
      byId("context").value = state.contextKey;
      renderContextDesc();
      renderGuardrails();
      byId("memo").value = state.memo;
      byId("charCount").textContent = `${state.memo.length}/600`;
      computeImpacts(); renderImpacts(); syncExport();
    }catch(err){ alert("Invalid JSON file."); }
  };
  reader.readAsText(file);
}

/* -------------------------
   Tooltips (data-key or data-tip)
-------------------------- */
let tipNode = null, tipHideTimer = null, tipShown = false;
function wireTooltips(){
  document.querySelectorAll(".info,[data-tip]").forEach(el=>{
    if(el.dataset.tipwired) return;
    el.dataset.tipwired = "1";
    el.addEventListener("mouseenter", ()=> showTip(el));
    el.addEventListener("mouseleave", hideTipSoon);
    el.addEventListener("focus", ()=> showTip(el));
    el.addEventListener("blur", hideTipSoon);
    el.addEventListener("click", (e)=>{ // touch-friendly
      if(tipShown) hideTipSoon(); else showTip(el);
      e.stopPropagation();
    });
  });
  document.addEventListener("click", (e)=>{
    if(tipNode && !tipNode.contains(e.target) && !e.target.closest(".info,[data-tip]")) hideTipSoon();
  });
}
function showTip(el){
  clearTimeout(tipHideTimer);
  const key = el.getAttribute("data-key");
  const tip = el.getAttribute("data-tip");
  let title="", body="";
  if(tip){ title="Info"; body=tip; }
  else if(key && GLOSSARY[key]){ title=GLOSSARY[key].title; body=GLOSSARY[key].body; }
  else { return; }
  tipNode = tipNode || byId("tooltip");
  tipNode.innerHTML = `<h4>${title}</h4><p>${body}</p>`;
  tipNode.style.display = "block";
  tipNode.setAttribute("aria-hidden","false");
  // position
  const r = el.getBoundingClientRect();
  const pad = 8;
  let top = r.bottom + pad + window.scrollY;
  let left = r.left + window.scrollX;
  const maxLeft = window.scrollX + document.documentElement.clientWidth - tipNode.offsetWidth - 10;
  left = Math.min(left, maxLeft);
  tipNode.style.top = top+"px";
  tipNode.style.left = left+"px";
  tipShown = true;
}
function hideTipSoon(){
  clearTimeout(tipHideTimer);
  tipHideTimer = setTimeout(()=>{
    if(tipNode){ tipNode.style.display="none"; tipNode.setAttribute("aria-hidden","true"); }
    tipShown = false;
  }, 120);
}

/* -------------------------
   Wiring
-------------------------- */
function wire(){
  // context
  const sel = byId("context");
  sel.addEventListener("change", ()=>{
    state.contextKey = sel.value;
    state.selected = new Set();
    renderContextDesc();
    renderGuardrails();
    computeImpacts(); renderImpacts(); syncExport();
  });

  // presets
  qsa('[data-preset]').forEach(b=>{
    b.addEventListener("click", ()=> applyPreset(b.dataset.preset));
  });

  // guardrail bulk
  byId("clearAll").addEventListener("click", ()=>{
    state.selected = new Set();
    renderGuardrails(); computeImpacts(); renderImpacts(); syncExport();
  });
  byId("selectAll").addEventListener("click", ()=>{
    const ids = CONTEXTS[state.contextKey].guardrails.map(g=>g.id);
    state.selected = new Set(ids);
    renderGuardrails(); computeImpacts(); renderImpacts(); syncExport();
  });

  // memo
  wireMemo();

  // print
  byId("printCheat").addEventListener("click", printCheat);

  // glossary
  byId("toggleGlossary").addEventListener("click", ()=>{
    const gl = byId("glossary");
    const isOpen = gl.classList.toggle("open");
    gl.setAttribute("aria-expanded", String(isOpen));
  });

  // export/import
  byId("btnExport").addEventListener("click", doExport);
  byId("btnImport").addEventListener("click", ()=> byId("file").click());
  byId("file").addEventListener("change", e=>{
    if(e.target.files && e.target.files[0]) doImport(e.target.files[0]);
  });

  // initial render
  renderContextDesc();
  renderGuardrails();
  computeImpacts(); renderImpacts();
  renderGlossary();
  syncExport();
  wireTooltips();
}

/* -------------------------
   Boot
-------------------------- */
let stateSnapshot = {};
document.addEventListener("DOMContentLoaded", wire);
</script>
</body>
</html>
